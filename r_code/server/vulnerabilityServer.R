
observeEvent(input$v_nextpage, {
  updateTabsetPanel(session, "tabset",
                    selected = "simulation")
})

observeEvent(input$v_prevpage, {
  updateTabsetPanel(session, "tabset",
                    selected = "hazard")
})




# 0.Tab specific Function for generating vulnerability graph
# (long-term move these to their own section)

v_graph_generate <- function(data=v_updated_structure_tbl$data, var = Damage_Percentage, g1_intensity = "Wind Speed",curve_type="Step") {
  
  data <-data%>%filter(Intensity!=""|Damage_Percentage!="")
  
  if(nrow(data)>1){
    data<-sapply(data,as.numeric)%>%as.data.frame()  
  }else{
    data<-data.frame(Intensity=as.numeric(data[1]),Damage_Percentage=as.numeric(data[2]))
  }
  
  g_data <-  rbind(if (g1_intensity == "Pressure")
    c(0, max(data$Damage_Percentage)) else c(0, 0), 
    data)
  
  if(g1_intensity == "Pressure"){
    g_data$Damage_Percentage
  }else{
    
  }
    
  if(curve_type=="Linear"){
    
    g_data <- rbind(approx(g_data$Intensity,g_data$Damage_Percentage,
                          xout=seq(min(g_data$Intensity),max(g_data$Intensity),by=1)),
                   data.frame(x=seq(max(g_data$Intensity),to=9999),
                              y=if(g1_intensity=="Pressure")
                                rep(0,length(seq(max(g_data$Intensity),to=9999))) else
                                rep(max(g_data$Damage_Percentage),length(seq(max(g_data$Intensity),to=9999)))))%>%
      rename(Intensity=x,Damage_Percentage=y)%>%
      mutate(`Damage Percentage` = percent(Damage_Percentage)) %>%
      arrange(Intensity)
    
  }else{
    
    g_data <- rbind(g_data,
              if (g1_intensity == "Pressure")
                c(9999, 0) else c(9999, max(data$Damage_Percentage)))%>%
      mutate(`Damage Percentage` = percent(Damage_Percentage)) %>%
      arrange(Intensity)
  }
  
  g_label <- "Damage Percentage"
  
  g_min_x<-0
  g <- g_data %>%
    ggplot(aes(Intensity, !!sym(var), label = !!sym(g_label))) + theme(panel.background = element_rect(fill = "cornsilk1",
                                                               colour = "cornsilk1"), panel.grid.minor = element_blank(), 
                                                               panel.border = element_rect(colour = "black",
                                                               fill = NA, size = 0.5), legend.key = element_rect(fill = "cornsilk1"),
                                                               legend.position = "bottom", text = element_text(size = 12.5))
    
  if(curve_type=="Step"){
    if (g1_intensity == "Pressure") {
      g <- g + geom_step(color = "red2", size = 1.3, alpha = 0.7, linetype = "solid",direction='vh') + scale_x_reverse() 
      g_min_x<-min(data$Intensity,na.rm=TRUE) * 0.95
    }else{
      g <- g + geom_step(color = "red2", size = 1.3, alpha = 0.7, linetype = "solid",direction='hv') 
      g_min_x<-0
    }
  }else{
    if (g1_intensity == "Pressure") {
      g <- g + geom_line(color = "red2", size = 1.3, alpha = 0.7, linetype = "solid") + scale_x_reverse() 
      g_min_x<-min(data$Intensity,na.rm=TRUE) * 0.95
    }else{
      g <- g + geom_line(color = "red2", size = 1.3, alpha = 0.7, linetype = "solid") 
      g_min_x<-0
    }
  }
  
  
    g <- g + labs(title = "Damage Percentage by Intensity", 
                  x = paste(input$v_intensity,"(", input$v_intensity_unit, ")"), 
                  y = "Damage - Percentage of Asset Value") +
      scale_y_continuous(labels = percent) + 
      coord_cartesian(xlim = c(g_min_x,max(data$Intensity,na.rm=TRUE) * 1.05), ylim = c(0,1.1))
 
  g <- ggplotly(g, tooltip = c("Intensity", "label"))
  
  return(g)
}

v_check<<-TRUE

# 1.Controls select input box display behaviour.  Measures vary by
# intensity.


observe({
  req(input$v_intensity)
  updateSelectInput(session, "v_intensity_unit", selected = "", 
                    choices = as.character(v_intensity_mappings[v_intensity_mappings$measure ==input$v_intensity, 
                                                              "unit"]))
})



# 2.Structure table behaviour.  Controls flow of inputs/outputs to
# structure table

# Holds updated values from user DT edits
v_updated_structure_tbl <<- reactiveValues(data = NULL)

# Default values. Re-update when intensity unit/measure is changed.
v_initial_structure <<- reactive({
  req(input$v_intensity_unit, input$v_intensity)
  data.frame(Intensity = as.numeric(v_intensity_mappings[v_intensity_mappings$unit ==input$v_intensity_unit, 
                                                     c("T0","T1", "T2", "T3", "T4", "T5")]), 
             Damage_Percentage = as.numeric(v_intensity_mappings[v_intensity_mappings$unit ==input$v_intensity_unit, c("P0","P1", "P2", "P3", "P4", "P5")]))
})

observe({
  v_updated_structure_tbl$data <- v_initial_structure()
})

# Stores all user inputted values in updated structure table
observeEvent(input$v_structure_DT_cell_edit, {
  
  info <- input$v_structure_DT_cell_edit %>%
    filter(col %in% c(1, 2))
  
  for (x in 1:6) {
    v_updated_structure_tbl$data[x, 1] <<- as.numeric(info[info$row ==
                                                             x & info$col == 1, "value"])
    
    v_updated_structure_tbl$data[x, 2] <<- as.numeric(info[info$row ==
                                                             x & info$col == 2, "value"])
  }
  
  v_updated_structure_tbl$data<<-v_updated_structure_tbl$data%>%replace(is.na(.), "")
  
})

# Renders DT after user edits. Only displays after all necessary
# inputs filled in.
output$v_structure_DT <- renderDT({
  
  req(input$v_intensity_unit, input$v_intensity)
  DT::datatable(v_updated_structure_tbl$data, options = list(dom = "t",ordering = F), 
                                                        editable = list(target = "all", 
                                                        disable = list(columns = c(0,3)))) %>%
    formatPercentage("Damage_Percentage", digits = 1) %>%
    formatCurrency("Intensity", digits = 1, 
                   currency = v_intensity_mappings$unit[v_intensity_mappings$unit ==input$v_intensity_unit], 
                   before = FALSE) %>%
    formatStyle(c("Intensity", "Damage_Percentage"), color = "white",
                backgroundColor = "#D41F29", fontWeight = "bold")
})

v_graph_display<-"Damage_Percentage"
  
# 3.Graph behaviour
output$v_structure_plot <- renderPlotly({
  
  req(input$v_intensity_unit, input$v_intensity,req(v_table_ok() == 1))
  if(v_check==TRUE){
  v_graph_generate(v_updated_structure_tbl$data,v_graph_display, input$v_intensity,input$v_curve_type)
  }
})

# 4.Data validation checks. Looks at a range of conditions to ensure
# the structure is valid.
v_table_ok <- reactiveVal(0)

observeEvent(c(v_updated_structure_tbl$data,input$v_curve_type), {
  
  print(v_updated_structure_tbl$data)
  
  v_table_check <-v_updated_structure_tbl$data%>%filter(Intensity!=""|Damage_Percentage!="")
  
  if(nrow(v_table_check)>1){
    v_table_check<-sapply(v_table_check,as.numeric)%>%as.data.frame()  
  }else{
    v_table_check<-data.frame(Intensity=as.numeric(v_table_check[1]),Damage_Percentage=as.numeric(v_table_check[2]))
  }
  
  v_check <<- (--((nrow(v_table_check) > if(input$v_curve_type=="Step"){0}else{1})&
                   !is.unsorted(v_table_check$Damage_Percentage,strictly=TRUE) &
                    !is.unsorted(if(input$v_intensity=="Pressure"){
                                       -v_table_check$Intensity
                                 }else{
                                        v_table_check$Intensity}
                                 ,strictly=TRUE) & 
                    all(v_table_check$Intensity > 0) & all(v_table_check$Damage_Percentage >=0) & 
                    all(v_table_check$Damage_Percentage <= 1)))
  v_table_ok(v_check)
  
  if (v_table_ok() == 1) {
    output$v_table_warning <- renderText({
      ""
    })
  } else {
    output$v_table_warning <- renderText({
      paste("Check table values. Note that all damage percentages must be between 0 and 1 and
       damage steps must",ifelse(input$v_intensity=="Pressure", "decrease","increase"),"in intensity 
       value and increase in damage%. No damage% values should exceed 100%")
    })
  }
}, ignoreInit = TRUE)


# 5.UI section complete checks
observeEvent(c(input$v_intensity_unit, input$v_intensity,
               input$v_reinstatement, v_table_ok()), {
                 
                 req(v_updated_structure_tbl$data)
                 if (isTruthy(input$v_intensity_unit) &
                     isTruthy(input$v_intensity) &
                     v_table_ok() == 1) {
                   output$v_vulnerability_complete <- renderText({
                     paste(as.character(icon("check-circle")), "Section Complete: Vulnerability Information Entered")
                   })
                   output$s_vulnerability_complete <- renderText({
                     paste("<span style=\"color:green;font-size:16px\">", as.character(icon("check-circle")),
                           "Vulnerability Section Complete")
                   })
                   s_vulnerability_ok<<-TRUE
                 } else {
                   output$v_vulnerability_complete <- renderText({
                     ""
                   })
                   output$s_vulnerability_complete <- renderText({
                     paste("<span style=\"color:red;font-size:16px\">", as.character(icon("times-circle")),
                           "Vulnerability Section Incomplete: Revisit This Tab Before Running Simulation")
                   })
                   s_vulnerability_ok<<-FALSE
                 }
                 
               }, ignoreInit = TRUE)

observeEvent(input$h_data_load, {
  
  output$v_suggested_intensity<-renderText({
    paste(h_mappings_selected$suggested_measure[1], "intensities are suitable for the hazard data loaded")
  })
  
})


output$s_vulnerability_complete <- renderText({
  paste("<span style=\"color:red;font-size:16px\">", as.character(icon("times-circle")),
        "Vulnerability Section Incomplete: Revisit This Tab Before Running Simulation")
})

s_vulnerability_ok<<-FALSE
