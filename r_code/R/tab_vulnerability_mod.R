vulnerability_text <-
  helpText(
    strong(
      "How much damage do different events cause? In the Vulnerability tab you 
       define how physical events translate into damage to your exposure. You 
       will define this as a relationship between your intensity measure (e.g., 
       wind speed Percentage of Climatology) and a damage percentage. In the 
       Risk Explorer, damage is measured as a percentage of the total 
       asset/policy value. It is assumed this directly corresponds to the 
       financial cost of repairing any damage. Note that this direct 
       relationship between the intensity measure and financial loss also 
       applies for parametric insurance covers, so this tab can effectively 
       be used to model these."),
    br(),
    br(),
    tags$ul(
      tags$li(
        strong("Step 1: Specify your intensity measure."),
        "The intensity measure is a hazard intensity parameter that should be 
         closely related to the likely damage caused by an event. For example, 
         wind speed or pressure would be suitable measures for a storm, as they 
         closely relate to the amount of damage likely to be caused. Recordings 
         of the intensity measure within your defined exposure area will 
         determine the damage sustained in an event. Intensity measures are 
         specific to the peril, The choices below are:"
      ),
        tags$ul(
          tags$li(strong("Windstorm")),
            tags$ul(
              tags$li(strong("Wind Speed"),": The maximum sustained wind speed 
              recorded in a given area. The precise measure of this may vary
              by meterological agency"),
              tags$li(strong("Pressure"),": The minimum sea level pressure  
              recorded in a given area. The precise measure of this may vary
              by meterological agency")
        ),
        tags$li(strong("Earthquake")),
        tags$ul(
          tags$li(strong("Peak Ground Acceleration"),": A measurement of how 
                  hard the ground shakes during an earthquake at a given 
                  location. It is recorded in terms of the earth’s standard 
                  acceleration due to gravity (denoted %g)")
        ),
        tags$li(strong("Drought: Unlike other perils, drought additionally 
                requires the user to input a growing season over which the 
                intensity measure will be calculated."), " This is because we are 
                typically concerned with drought over a particular growing 
                season rather than the whole year. The user can override any 
                defaults for more localised preferences if required, with the 
                app defaulting to IPCC region-level growing season 
                baselines. "),
        tags$ul(
          tags$li(strong("Percentage of Climatology"),
                  "
                  : A measurement of the precipitation anomaly, i.e. the 
                  relativity between the rainfall recorded for a 
                  given period and the average over a representative multi-year 
                  average (the climatology).
                  A reading of 100% represents completely average rainfall 
                  over the period during a user-defined season, below 100% is 
                  drier than average and above 100% is wetter than average. The 
                  difference is expressed in terms of ‘% climatology’, where the 
                  climatology is the long-term (1984-2020) mean of rainfall for 
                  the user-defined season in question
                  "
                  ),
          tags$li(strong("Dry Days Index"),": An index representing the 
          consecutive number of 'dry' days of length greater than or equal to a 
          pre-defined threshold. What constitutes dry here is defined as a user 
          inputted % of seasonal climatology (see definiton above). This concept 
          is not intuitive, users are advised to consult the help before 
          experiementing with this option")
        )
      ),
      br(),
      tags$li(
        strong("Step 2: Specify your vulnerability curve type."),
        "The curve type you enter determines how the damage percentages you 
         specify change as the intensity measure increases/decreases. You can 
         choose from a stepped or linear vulnerability curve. It is worth 
         choosing both options and consulting the graph below to see how this 
         works in practice.",
        br(),
        br(),
        tags$ul(
          tags$li(
            strong("Step:"),
            "This curve replicates how most parametric covers work. The damage 
             generated increases in \"steps\" corresponding to the highest 
             specified intensity measure exceeded. For example, with the default 
             values in the grid below (these will appear once you've completed 
             the first step), it would be assumed that you would sustain damage 
             amounting to 20% of your asset's value if wind speeds greater than 
             119km/h are recorded at your chosen exposure. However, if winds 
             exceeding 154km/h were recorded you would sustain damage amounting 
             to 40% of your asset's value."),
          tags$li(
            strong("Linear:"),
            "This curve is closer to the approach used in catastrophe modelling, 
             where a more detailed approach is used to specify the damage 
             generated at each value of the intensity measure. The damage 
             generated increases linearly for the values you enter in the grid. 
             For example, with the default values below, it would be assumed 
             that you would sustain damage amounting to 20% of your asset's 
             value if wind speeds of 119km/h are recorded and 40% of your asset's 
             value if winds of 154km/h were recorded. For wind speeds between 
             these two points, it is assumed damage increases linearly with wind 
             speed. For example, winds of 136.5km/h would lead to a 30% damage 
             whereas in the step function example, this would still be 20%."))),
      br(),
      tags$li(
        strong("Step 3: Enter your damage percentage at each selected level of 
        intensity."),
        "This section determines how much damage is sustained at each point of 
        the intensity measure you specify.The values you specify here and your 
        Step 2 selection will determine the overall shape of the 
        intensity-to-damage curve. Note that you can enter anywhere between one 
        and six separate intensity-damage rows here."
      )
    )
  )


tab_vulnerability_UI <- function(id) {
  ns <- NS(id)
  tagList(
    shiny::titlePanel("3.Vulnerability"),
    shiny::conditionalPanel(
      condition = "output.display_vulnerability_tab",
      ns = ns,
      display_help_text_UI(ns("help_text_vulnerability")),
      tags$a(
        "For more detail see the Help page's Vulnerability user guide or press 
        the Display Help button above",
        href = "https://oasislmf.github.io/RiskExplorer/components/index_Walkthrough.html#vulnerability",
        target = "_blank"
      ),
      br(),
      br(),
      v_trigger_choices_UI(ns("trigger_choices1")),
      v_trigger_payouts_UI(ns("trigger_payouts1")),
      v_trigger_checks_UI(ns("trigger_checks1")),
      v_trigger_chart_UI(ns("trigger_chart1"))),
    shiny::conditionalPanel(
      condition = "!output.display_vulnerability_tab",
      ns = ns,
      helpText(strong("Please return to Hazard tab and load valid hazard 
                       data"),
               br(),
               br())),
    section_complete_page_UI(ns("section_vulnerability1")),
    page_nav_UI(ns("vulnerability"))
  )
}

tab_vulnerability_Server <- function(id, parent, selected_hazard_mappings, 
                                     v_mappings) {
  moduleServer(
    id,
    function(input, output, session) {
      
      tab_check_ok <- reactiveVal(FALSE)
      
      display_help_text_Server(
        "help_text_vulnerability",
        text = vulnerability_text  
      )
      
      output$display_vulnerability_tab <- 
        reactive({
          
          tryCatch({
            isTruthy(selected_hazard_mappings())
              TRUE
            },
            shiny.silent.error = function(e) {
              FALSE
            })
        })
      
      outputOptions(output, 
                    name = "display_vulnerability_tab", 
                    suspendWhenHidden = FALSE)
      
      trigger_choices <- 
        v_trigger_choices_Server("trigger_choices1", 
                          selected_hazard_mappings = selected_hazard_mappings,
                          v_mappings = v_mappings)
      
      trigger_payouts <-
        v_trigger_payouts_Server("trigger_payouts1", 
                                  trigger_choices = trigger_choices$trigger_choices, 
                                  v_mappings = v_mappings)
      
      table_ok <- 
        v_trigger_checks_Server("trigger_checks1", 
                                trigger_payouts = trigger_payouts,
                                trigger_choices = trigger_choices$trigger_choices)
      
      v_trigger_chart_Server("trigger_chart1", 
                              trigger_payouts = trigger_payouts,
                              trigger_choices = trigger_choices$trigger_choices, 
                              table_ok = table_ok)
      
      observe({
        
        tab_check_ok(FALSE)
        req(trigger_choices$section_ok(), 
            table_ok$section_ok())
        
        tab_check_ok(TRUE)
      })
      
      section_complete_page_Server("section_vulnerability1",
                                   check_ok = tab_check_ok,
                                   section = "Vulnerability")
      
      page_nav_Server("vulnerability",
                      parent = parent,
                      prev_page  = "exposure", 
                      next_page = "simulation")
      
      return(list(trigger_choices = trigger_choices$trigger_choices,
                  trigger_payouts = trigger_payouts,
                  tab_check_ok = tab_check_ok))

    }
  )
}
